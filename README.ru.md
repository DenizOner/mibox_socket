<!-- Выбор языка -->
[English](README.md) | [Türkçe](README.tr.md) | [Español](README.es.md) | [Русский](README.ru.md)

# MiPower

MiPower — это пользовательская интеграция для Home Assistant, которая позволяет включать **Mi Box S** через Bluetooth-паринг (с использованием `bluetoothctl`). Mi Box S не содержит ИК-приемник дистанционного управления, как некоторые другие модели Mi Box; поэтому этот модель можно надежно управлять только с помощью Bluetooth-пульта. MiPower реализует практичное решение для ограничения, связанного с глубоким сном устройства.

**Почему возник проект:**  
Выключить Mi Box S можно с помощью ADB-команды, но включить его можно только с помощью физического пульта, потому что устройство переходит в режим глубокого сна. Эта интеграция использует последовательность паринга `bluetoothctl`, чтобы удаленно разбудить устройство — прагматичное решение, помогающее управлять Mi Box S через Home Assistant без оригинального пульта.

---

## Возможности
- Создает переключатель (switch) в Home Assistant, который пытается разбудить Mi Box S через контролируемую попытку паринга Bluetooth.
- Простая настройка через UI (MAC-адрес + удобное имя).
- Совместимость с HACS (Home Assistant Community Store) как кастомная интеграция.
- Включены переводы на английский и турецкий; можно добавить дополнительные языки.

---

## Совместимость и требования
- ОС хоста: Linux с BlueZ (например, Raspberry Pi OS). На хосте должен быть доступен `bluetoothctl`.
- Home Assistant должен работать в окружении (хост/контейнер), имеющем доступ к Bluetooth-интерфейсу хоста и DBus (BlueZ). Для контейнеров может потребоваться монтирование `/run/dbus` и предоставление прав на устройство.
- Python-зависимость, заявленная в `manifest.json`: **pexpect** (управление сессиями `bluetoothctl`).
- Минимальная версия Home Assistant по метаданным: **2021.12.0**.
- Домен интеграции: `mibox_socket` (файлы размещаются в `custom_components/mibox_socket`).

---

## Установка

Поддерживаются два метода установки. Файлы должны находиться в `custom_components/mibox_socket`.

### 1) Ручная установка (копирование файлов)
1. Создайте каталог: `config/custom_components/mibox_socket`
2. Скопируйте все файлы из `custom_components/mibox_socket` этого репозитория в созданный каталог, сохранив структуру (`translations/`, `manifest.json`, `switch.py`, `config_flow.py`, `__init__.py`, `const.py` и др.).
3. Убедитесь, что `bluetoothctl` установлен на хосте и Home Assistant имеет доступ к DBus.
4. Перезапустите Home Assistant.

> После перезапуска продолжите с разделом **Конфигурация** ниже.

### 2) Установка через HACS (рекомендуется)
1. Откройте Home Assistant → **HACS** → **Integrations**.
	![HACS главный экран](docs/images/hacs_main.png)  
	*Основной вид раздела Integrations в HACS.*

2. Нажмите меню из трёх точек → **Custom repositories**.
	![HACS пользовательские репозитории](docs/images/hacs_custom_repos.png)  
	*Откройте диалог «Custom repositories» через меню с тремя точками.*

3. Добавьте репозиторий:
   - URL: `https://github.com/DenizOner/MiPower`
   - Категория / Тип: **Integration**
	![HACS добавить репозиторий](docs/images/hacs_add_repo.png)  
	*Добавьте URL репозитория и выберите тип «Integration».*

4. После индексирования репозитория в HACS перейдите в **HACS → Integrations**, найдите **MiPower** и установите.
	![HACS установить интеграцию](docs/images/hacs_install_integration.png)  
	*Установите интеграцию MiPower через HACS → Integrations.*

5. При необходимости перезапустите Home Assistant.

> После перезапуска продолжите с разделом **Конфигурация**.

---

## Конфигурация (после установки)
1. В Home Assistant откройте **Settings → Devices & Services**.
	![Настройки → Устройства и Сервисы](docs/images/settings_devices_services.png)  
	*Откройте «Devices & Services», чтобы добавить интеграцию.*

2. Нажмите **Add Integration**.
	![Кнопка Добавить интеграцию](docs/images/add_integration_button.png)  
	*Нажмите кнопку «Add Integration» (расположение кнопки зависит от версии HA).*

3. Найдите **MiPower** и выберите.
	![Поле поиска](docs/images/search_mipower.png)  
	*Поле поиска: введите имя интеграции.*

4. Заполните форму настройки:
   - **MAC address** (обязательно): Bluetooth MAC вашего Mi Box S (`XX:XX:XX:XX:XX:XX`).
   - **Friendly name** (обязательно): метка для switch-сущности.
   - **Опционально**: при желании можно привязать существующую сущность `media_player`.
	![Форма настройки MiPower](docs/images/mipower_config_form.png)  
	*Введите MAC устройства в формате `AA:BB:CC:DD:EE:FF`, укажите удобное имя и отправьте.*

5. Подтвердите. Появится новый switch (например, `switch.<friendly_name>`).

---

## Принцип работы
- При включении switch MiPower инициирует попытку паринга `bluetoothctl` к MAC-адресу Mi Box S через контролируемую сессию (с помощью `pexpect`). Попытка паринга служит сигналом для пробуждения устройства.
- Метод является обходным решением для режима глубокого сна устройства и не меняет прошивку или настройки устройства.

---

## Рекомендации по использованию
- Убедитесь, что Bluetooth-адаптер хоста работает (`sudo bluetoothctl`).
- Mi Box S должен находиться в зоне действия; помехи и условия RF влияют на успех.
- Не отправляйте команды паринга слишком часто подряд.
- Интеграция не изменяет прошивку устройства; выполняется только попытка паринга для пробуждения.

---

## Устранение неполадок
- Проверьте корректность MAC-адреса.
- Убедитесь, что BlueZ и `bluetoothctl` могут обнаруживать/подключаться к устройствам на хосте.
- Проверьте логи Home Assistant, связанные с `mibox_socket` (при необходимости включите debug-уровень).
- Для контейнерных установок убедитесь, что `/run/dbus` смонтирован и заданы права.

---

## Вклад в проект
Приветствуются вклады:
- Откройте Issue для багов или запросов функций.
- Форкните репозиторий, внесите изменения в ветке и откройте Pull Request.
- Документируйте изменения и добавьте шаги тестирования при необходимости.

---

## Обратная связь и поддержка
Используйте GitHub Issues для отчетов и предложений. Укажите версию Home Assistant, тип установки, ОС хоста, версию BlueZ, релевантные логи и шаги, которые вы выполнили.

---

## Безопасность и конфиденциальность
- MiPower выполняет локальные попытки паринга Bluetooth и не передаёт персональные данные наружу.
- Интеграция требует доступа к Bluetooth/DBus на уровне хоста; используйте на доверенных хостах.

---

## Лицензия
Проект опубликован в общественном достоянии под лицензией **Creative Commons CC0 1.0 Universal (CC0 1.0)**. Вы можете копировать, модифицировать и распространять проект без ограничений.
Ссылка: https://creativecommons.org/publicdomain/zero/1.0/

---

## Благодарности и происхождение
MiPower — это форк проекта `mibox_socket` пользователя @frlequ — многие ключевые идеи и первоначальная реализация были заимствованы из этого репозитория.
